<?php if(!defined('BASEPATH')) exit('Access Denied!!');

class Loans extends CI_Controller{
    
	 protected $models = array(
	 
				'sys_object' => 'systemobject_model',
				
				'sys_option' => 'systemoption_model',
				
				'product' => 'product_model',
		 
				'loan' => 'loan_model',

				'loan_charge' => 'charge_model',
				
				'collateral' => 'collateral_model',
				
				'account' => 'account_model',
				
				'transaction' => 'transaction_model',
				
				'customer' => 'customer_model',
				
				'customer_account' => 'customeraccount_model',

				'expected_payment' => 'expectedpayment_model',

				'payment' => 'payment_model',

				'charge_payment' => 'chargepayment_model',
				
				'gaurantor' => 'gaurantor_model',
			
	 );
	 
	 protected $header = 'mombo/layout/header'; //set header template file
	  
	 protected $footer = 'mombo/layout/footer'; //set footer template file

     public function index(){
	 
			$criteria = strtolower(trim($this->input->get_post('criteria')));
			
			$message  = null;
			
			$errors   = array();
			
			$loans    = null;
			
			if($criteria && in_array($criteria,array('issued','requested',))){
			
			        $request_status = 2;
			
					switch($criteria){
					
							case 'requested': $request_status = 1; break;
							
							case 'issued'   : break;

							default:break;
					}
					
					$loans    = $this->loan->findBy(array(
					
							'request_status' => $request_status,
							
					));
			
			}else{
			        
					$criteria = 'all';
					
					$loans    = $this->loan->findAll();
					
			}
			
			$this->page->title     = "Mombo Loan System | Loans";
			
			$this->page->name      = 'mombo-loans';
			
			$this->msg['page']     = $this->page;
			
			$this->msg['criteria'] = $criteria;
			
			$this->msg['requests'] = $loans;
			
			$this->sendResponse($this->msg, array(
					
					$this->header => $this->msg,
					
					'mombo/templates/loanrequests' => $this->msg,
					
					$this->footer => $this->msg,
					
			   )
			   
			);
	 
	 }
	 
	 /******Loan Products******/
	 
			 public function addnewproduct(){
			 
					$message = null;
					
					$errors  = array();
			 
					if($this->input->post('add_product')){
					
							$product = $this->input->post('product');
							
							$product['status'] = 1;
							
							switch($product['loan_repayment_frequency']){
									
									case 'weekly'   : $product['repayment_frequency_single'] = 'week'; break;
									
									case 'monthly'  : $product['repayment_frequency_single'] = 'month'; break;
									
									case 'annually' : $product['repaymeny_frequency_single'] = 'year'; break;
									
									case 'per-two-months': $product['repaymeny_frequency_single'] = 'two months';break;
																
									case 'per-three-months':$product['repaymeny_frequency_single'] = 'three months';break;
									
									case 'quartely':$product['repaymeny_frequency_single'] = 'quarter';break;
									
									case 'per-five-months':$product['repaymeny_frequency_single'] = 'five months';break;
									
									case 'twice-annually':$product['repaymeny_frequency_single'] = 'half year';break;
							
							}

                          
							
							$added   = $this->product->create($product);
							
							if($added) redirect(base_url().'loans/loanproducts?message=product successfully added&message_type=success');
							
							$message = "Error adding product. Please review your inputs and try again";
							
							$errors  = $this->product->validationerrors();
					
					}
					
					$this->page->title      = "Mombo Loan System | Add New Product";
					
					$this->page->name       = 'mombo-addproduct';
							
					$this->msg['page']      = $this->page;
					
					$this->msg['criteria']  = '';
					
					$this->msg['message']   = $message;
					
					$this->msg['errors']    = $errors;
					
					$this->msg['product']   = $this->product;
					
					$this->sendResponse($this->msg,array(
					
							$this->header => $this->msg,
							
							'mombo/templates/addnewloanproduct' => $this->msg,
							
							$this->footer => $this->msg
					));
			 
			 }
			 
			 
			 public function editproduct(){
			 	
					$message     = null;
					
					$errors      = array();
					
					$product_id  = (int) $this->input->get_post('product_id');
					
					if(!isset($product_id) || empty($produc_id) || $product_id != '' || null != $product_id){
						
						         $product_id = ($product = $this->input->post('product')) ? $product['id'] : $product_id;
						
					} 
							
					
					if($product_id){
					        
							$product = $this->product->findOne($product_id);
					
							if(null != $product){
							        
									$this->product = $product;
			 
									if($this->input->post('edit_product')){
									
											$product = $this->input->post('product');
											
											switch($product['loan_repayment_frequency']){
											
													case 'weekly'   : $product['repayment_frequency_single'] = 'week'; break;
													
													case 'monthly'  : $product['repayment_frequency_single'] = 'month'; break;
													
													case 'annually' : $product['repaymeny_frequency_single'] = 'year'; break;
													
													case 'per-two-months': $product['repaymeny_frequency_single'] = 'two months';break;
																				
													case 'per-three-months':$product['repaymeny_frequency_single'] = 'three months';break;
													
													case 'quartely':$product['repaymeny_frequency_single'] = 'quarter';break;
													
													case 'per-five-months':$product['repaymeny_frequency_single'] = 'five months';break;
													
													case 'twice-annually':$product['repaymeny_frequency_single'] = 'half year';break;
																				
											
											}

											
											$added   = $this->product->doupdate($product);
											
											if($added) redirect(base_url().'loans/loanproducts?message=product successfully updated&message_type=success');
											
											$message = "Error editing product. Please review your inputs and try again";
											
											$errors  = $this->product->validationerrors();
									
									}
								
							}else{
							
									redirect(base_url().'loans/loanproducts?message=Error!. Product not found&message_type=warning');
							
							}
						
					}else{
					
							redirect(base_url().'loans/loanproducts?message=Error!. Action\'s minimum requirement not met&message_type=warning');
					
					}
					
					$this->page->title      = "Mombo Loan System | Edit Product";
					
					$this->page->name       = 'mombo-editproduct';
							
					$this->msg['page']      = $this->page;
					
					$this->msg['criteria']  = '';
					
					$this->msg['message']   = $message;
					
					$this->msg['errors']    = $errors;
					
					$this->msg['product']   = $this->product;
					
					$this->sendResponse($this->msg,array(
					
							$this->header => $this->msg,
							
							'mombo/templates/editloanproduct' => $this->msg,
							
							$this->footer => $this->msg
					));
			 
			 }
			 
			 public function deleteproduct(){
			 
					$product_id = (int) $this->input->get_post('product_id');
					
					if($product_id){
					
							$product = $this->product->findOne($product_id);
							
							if(null != $product){
							
									if($this->input->get_post('confirmed')){
									
											if($product->delete()) redirect(base_url().'loans/loanproducts/?message=Loan product deleted successfully!&message_type=success');
									
											redirect(base_url().'loans/loanproducts/?message=Error deleting product&message_type=warning');
										
									}
							
							}else{
							
									redirect(base_url().'loans/loanproducts/?message=Error. Loan product does not exists&message_type=warning');
							
							}
					
					}else{
					   
							redirect(base_url().'loans/loanproducts?message=Error!. Action\'s minimum requirement not met&message_type=warning');
								
					}
					
					$this->page->title 		= "Mombo Loan System | Confirm Delete";
					
					$this->page->name  		= 'mombo-delete-product';
					
					$this->msg['page'] 		= $this->page;
					
					$this->msg['message']   = "Do you really want to delete this product";
					
					$this->msg['yes_url']   = base_url().'loans/deleteproduct/?confirmed=true&product_id='.$product_id;
					
					$this->msg['no_url']    = base_url().'loans/productdetails/?product_id='.$product_id;
					
					$this->sendResponse($this->msg,array(
						
								$this->header=>$this->msg,
								
								'mombo/templates/confirm'=>$this->msg,
								
								$this->footer=>$this->msg,
							
						)
					 
					);
			 
			 }
			 
			 
			 public function productdetails(){
			 
					$product_id        = (int) $this->input->get_post('product_id');
					
					$loans             = array();
					
					$loans_settled     = array();
					
					$loan_requests     = array();
					
					$accepted_requests = array();
					
					$denied_requests   = array();
					
					
					if($product_id){
					
							$product = $this->product->findOne($product_id);
							
							if(null != $product){
								
								    $this->product = $product;
									
									$loans = $this->loan->findBy(array(
									
											'loan_product' => $this->product->id,
											
									));
									
									$loans_settled = $this->loan->findBy(array(
									
											'loan_product' => $this->product->id,
											
											'loan_status'  => 1,
									
									));
									
									$loan_requests  =  $this->loan->findBy(array(
											
											'loan_status'  => 0,
											
											'request_status' => 1
									
									  )
									);
									
									$accepted_requests  =  $this->loan->findBy(array(
											
											'loan_status'  => 0,
											
											'request_status' => 2
									
									  )
									);
									
									$denied_requests  =  $this->loan->findBy(array(
											
											'loan_status'  => 0,
											
											'request_status' =>3
									
									  )
									);
							
							}else{
							
								   redirect(base_url().'loans/loanproducts/?message=Error. Loan product does not exists&message_type=warning');
								   
							}
					
					}else{
					
							redirect(base_url().'loans/loanproducts?message=Error!. Action\'s minimum requirement not met&message_type=warning');
							
					}
					
					
					$this->page->title             	= "Mombo Loan System | Product Summary";
					
					$this->page->name				= 'mombo-product-details';
					
					$this->msg['page']             	= $this->page;
					
					$this->msg['product']         	= $this->product;
					
					$this->msg['loans']           	= $loans;
					 
					$this->msg['loans_settled']    	= $loans_settled;
					
					$this->msg['loan_requests']    	= $loan_requests;
					
					$this->msg['denied_requests']  	= $denied_requests;
					
					$this->msg['accepted_requests'] = $accepted_requests;
					
					$this->sendResponse($this->msg,array(
					
							$this->header => $this->msg,
							
							'mombo/templates/productdetails' => $this->msg,
							
							$this->footer => $this->msg,
					
					));
			 
			 }
			 
			 public function loanproducts(){
			   
					$products 		= $this->product->findAll(array((int)$this->input->get_post('per_page'),20));
					
					$message		= $this->input->get_post('message');
					
					$message_type   = $this->input->get_post('message_type');
					
					$this->page->title          = "Mombo Loan System | Loan Products";
					
					$this->page->name           = 'mombo-loan-products';
					
					$this->msg['page']    	    = $this->page;
					
					$this->msg['products'] 		= $products;
					
					$this->msg['message']  		= $message;
					
					$this->msg['message_type']  = $message_type;
					
					$this->sendResponse($this->msg,array(
					
							$this->header => $this->msg,
							
							'mombo/templates/loanproducts' => $this->msg,
							
							$this->footer => $this->msg,
					  )
					);
			 
			 }
	 
	 /******End Loan products******/
	 
	 /******Loan Requests******/
	 
			 public function loanrequests(){
			 
			 
			        $criteria		 = strtolower($this->input->get_post('criteria')); //get product criteria to such for
					
					$product_id      = (int) $this->input->get_post('product_id');
					
					$message 		 = $this->input->get_post('message');
					
					$message_type    = $this->input->get_post('message_type');
					
					$requests = null;
					
					if($criteria && in_array($criteria,array('den','acc','new'))){
					        
							$status = 0;
							
					        switch($criteria){
							
									case 'den': $status = 3; break;
									
									case 'acc':	$status = 2; break;
									
									case 'new': $status = 1; break;
									
									default:break;
							}
					
							$requests = $this->loan->findBy(
							
								  array(
									 
										 'loan_status' => 0,
										 
										 'request_status' => $status,
										 
									 ),
									 
								  array(
								  
										 (int)$this->input->get_post('per_page'),
										 
										  20,
									  
									)
								
							 );
							 
							 if($product_id){
							 
							 
										if($this->product->findOne($product_id)){
							 
												$requests = $this->loan->findBy(
										
													  array(
														 
															 'loan_status' => 0,
															 
															 'request_status' => $status,
														 
															 'loan_product' => $product_id,
															 
														 ),
														 
													  array(
														  
															 (int)$this->input->get_post('per_page'),
															 
															  20,
														  
														)
													
												);
												
										 }else{
										 
											  redirect(base_url().'loans/loanrequests/?message=Error loan product cannot be found&message_type=warning');
										 
										 }
							}
							
					}else{
					
							$criteria  = 'all';
							
							$requests  = $this->loan->findAll(array(
							
									(int) $this->input->get_post('per_page'),
									
									20,
							
							));
							
							if($product_id){
							 
							 
										if($this->product->findOne($product_id)){
							 
												$requests = $this->loan->findBy(
										
													  array(
														 
															 'loan_status' => 0,
															
															 'loan_product' => $product_id,
															 
														 ),
														 
													  array(
														  
															 (int)$this->input->get_post('per_page'),
															 
															  20,
														  
														)
													
												);
												
										 }else{
										 
											  redirect(base_url().'loans/loanrequests/?message=Error loan product cannot be found&message_type=warning');
										 
										 }
							}
					}
					
					$this->page->title           = "Mombo Loan System | Loan Requests";
					
					$this->page->name            = 'mombo-loan-products';
					
					$this->msg['page']    	     = $this->page;
					
					$this->msg['requests']		 = $requests;
					
					$this->msg['message']  		 = $message;
					
					$this->msg['message_type']   = $message_type;
					
					$this->msg['criteria']       = $criteria;
					
					$this->sendResponse($this->msg,array(
					
							$this->header => $this->msg,
							
							'mombo/templates/loanrequests' => $this->msg,
							
							$this->footer => $this->msg,
					  )
					);
			 
			 }

			 public function getloanchargesandpayments(){

			 	   $loan_id = (int) $this->input->get_post('loan_id');

			 	   if($loan_id){

			 	   		   $loan = $this->loan->findOne($loan_id);

			 	   	       if(null != $loan){

			 	   	       			$this->msg['loan_charges']     = $this->loan_charge->findBy(array('loan'=>$loan->id));

			 	   	       			$this->msg['loan_payments']    = $this->expected_payment->findBy(array('loan'=>$loan->id));

			 	   	       			$this->msg['message'] 	       = 'OK';

			 	   	       			$this->msg['responsecode']     = 200;

			 	   	       }else{

			 	   	       		$this->msg['message']       = "Loan item does not exists";

			 	   	       	    $this->msg['responsecode']  = 404;

			 	   	       }


			 	   }else{

			 	   			$this->msg['message']       = "Loan item does not exists";

			 	   			$this->msg['responsecode']  = 404;

			 	   }

			 	   $this->sendResponse($this->msg);
			 }


			 public function findloansby(){

			 	  $by        = strtolower(trim($this->input->get_post('by')));

			 	  $criteria  =  strtolower(trim($this->input->get_post('criteria')));

			 	  $loans     = null;

			 	  if($by && in_array($by,array('id','customer','product','customer_idnum'))){

			 	  	        $field = 'id';

			 	  	        $value = 0;

			 	  			switch($by){

			 	  				  case 'id' :            $value = (int) $this->input->get_post('loan_id');break;

			 	  				  case 'customer':       $field =  'customer';$value = (int) $this->input->get_post('customer_id');break;
								  
								  case 'customer_idnum': $field =  'customer';$value = $this->customer->findBy(array('idnumber'=>(int)$this->input->get_post('customer_id')))->row(0,'customer_model')->id;break;

			 	  				  case 'product' :       $field =  'loan_product';$value = (int) $this->input->get_post('product_id');break;

			 	  				  default:break;

			 	  			}

			 	  			if($criteria && in_array($criteria,array('paid','unpaid'))){
					
									$status  = 0;
									
									switch($criteria){
									
											case 'paid': $status = 1; break;
											
											default:break;
									
									}
									
								
									$loans   = $this->loan->findBy(
									
											array(
													 $field => $value,

													'request_status'=>2,
													
													'loan_status'=>$status
													
											)
											
									);
									
								
							}else{
							
								   $loans   = $this->loan->findBy(
									
											array(
													 $field => $value,

													'request_status'=>2
													
											)
											
									);
								
							}

				}else{
									
						 if($criteria && in_array($criteria,array('paid','unpaid'))){
					
								$status  = 0;
								
								switch($criteria){
								
										case 'paid': $status = 1; break;
										
										default:break;
								
								}
						
								$loans   = $this->loan->findBy(
								
										array(
												
												'request_status'=>2,
												
												'loan_status'=>$status
												
										)
										
								);

					    }else{

                            
								 $loans = $this->loan->findBy(array(

									  'request_status'=>2,

								 ));

                        }		
						  

				 }


			 	  $this->msg['loans'] = $loans;

			 	  $this->sendResponse($this->msg);
			 }
			 
			 public function loansissued(){
					
					$criteria      = strtolower($this->input->get_post('criteria'));
					
					$product_id    = (int) $this->input->get_post('product_id');
					
					$message       = $this->input->get_post('message');
					
					$message_type  = $this->input->get_post('message_type');
					
					$loans         = null;
					
					if($criteria && in_array($criteria,array('paid','unpaid'))){
					
							$status  = 1;
							
							switch($criteria){
							
									case 'unpaid': $status = 0; break;
									
									default:break;
							
							}
					
							$loans   = $this->loan->findBy(
							
									array(
											
											'request_status'=>2,
											
											'loan_status'=>$status
											
									),
									
									array(
									
											(int)$this->input->get_post('per_page'),
											
											20,
									)
									
							);
							
							if($product_id){
							
									 if($this->product->findOne($product_id)){
							 
											$loans = $this->loan->findBy(
									
												  array(
													 
														 'loan_status' => $status,
														 
														 'request_status' => 2,
													 
														 'loan_product' => $product_id,
														 
													 ),
													 
												  array(
													  
														 (int)$this->input->get_post('per_page'),
														 
														  20,
													  
													)
												
											);
										
									 }else{
									 
										  redirect(base_url().'loans/loansissued/?message=Error loan product cannot be found&message_type=warning');
									 
									 }
							}
							
					}else{
					
						    $criteria  = 'all';
							
							$loans     = $this->loan->findBy(
							
								array(
										
										'request_status'=>2,
										
								),
								
								array(
								
										(int)$this->input->get_post('per_page'),
										
										20,
								)
								
							);
							
							if($product_id){
							
									 if($this->product->findOne($product_id)){
							 
											$loans = $this->loan->findBy(
									
												  array(
														 
														 'request_status' => 2,
													 
														 'loan_product' => $product_id,
														 
													 ),
													 
												  array(
													  
														 (int)$this->input->get_post('per_page'),
														 
														  20,
													  
													)
												
											);
										
									 }else{
									 
										  redirect(base_url().'loans/loansissued/?message=Error loan product cannot be found&message_type=warning');
									 
									 }
							}
					}
					
					
					$this->page->title         = "Mombo Loan System | Loans Issued";
					
					$this->page->name          = 'mombo-issued-loans';
					
					$this->msg['page']         = $this->page;
					
					$this->msg['message']	   = $message;
					
					$this->msg['message_type'] = $message_type;
					
					$this->msg['criteria']     = $criteria;
					
					$this->msg['loans']   	   = $loans;
					
					$this->sendResponse($this->msg,array(
					
							$this->header => $this->msg,
							
							'mombo/templates/loansissued' => $this->msg,
							
							$this->footer => $this->msg,
					  )
					);
			 }
			 
			 public function editloanrequest(){
			 
			        $loan_id = (int) $this->input->get_post('loan_id');
					
					$message = null;
					
					$errors  = array();
					
					if(!isset($loan_id) || empty($loan_id) || $loan_id != '' || null != $loan_id){
						
						         $loan_id = ($request = $this->input->post('request')) ? $request['id'] : $loan_id;
						
					} 
			 
					if($loan_id){
					
					        $request = $this->loan->findOne($loan_id);
							
							if(null != $request){
							
									if(null == $this->collateral->findBy(array('loan' => $request->id))->row(0,'collateral_model')){
									
											$created = $this->collateral->create(array(
													
													'loan' =>  $request->id,
													
													'name' => '',
													
													'description' => null
													
												)
											
											);

											if(!$created){
											
												redirect(base_url().'loans/loanrequests/?message=Error updating loan request. Something went wrong please try again. Collateral&message_type=warning');
											
											}
										
									}
									
									if(null == $this->gaurantor->findBy(array('loan' =>  $request->id))->row(0,'gaurantor_model')){
									
											$created = $this->gaurantor->create(array(
													
													'loan' =>  $request->id,
													
													'name' => '',
													
													'other_names' => ''
													
												)
											
											);

											if(!$created){
											
													redirect(base_url().'loans/loanrequests/?message=Error updating loan request. Something went wrong please try again. Gaurantors&message_type=warning');
											
											}
										
									}
							
									if($this->input->post('edit_request')){
									
												$collateral     = $this->input->post('collateral');
												
												$edit_request   = $this->input->post('request');
												
												$gaurantor      = $this->input->post('gaurantor');
												
												//var_dump($_FILES['request_gaurantorpic']);exit();
												
												if(!empty($_FILES['request_gaurantorpic']) && $_FILES['request_gaurantorpic']['name']){
												
														$gaurantor_pic  = $this->upload->do_upload('request_gaurantorpic');
														
														if($gaurantor_pic){
														
																$upload = $this->upload->data();
																
																$gaurantor['profilepic'] = $upload['file_name'];
														
														}else{
																
																$message = "<p>Error uploading gaurantor's picture.</p>".$this->upload->display_errors();;
																
																$gaurantor['profilepic'] = $request->guarantor->profilepic;
														
														}
												}else{
												
														$gaurantor['profilepic'] = $request->gaurantor->profilepic;
												
												}
												
												if($this->collateral->doupdate($collateral) && $this->loan->doupdate($edit_request) && $this->gaurantor->doupdate($gaurantor) && $message == null ){
												
														redirect(base_url().'loans/loanrequests/?message=Successfully updated loan request&message_type=success');
												
												}else{
												
														if(null == $message){
														
																$message = 'Error updating request. Please review your inputs';
														  
														}
														
														$errors  = array_merge($this->collateral->validationerrors(),$this->loan->validationerrors(),$this->gaurantor->validationerrors());
														
														//var_dump($errors);
												
												}
												
												
									}
									
									$this->loan        = $request;
									
									$this->collateral  = $this->collateral->findBy(array('loan' => $request->id))->row(0,'collateral_model');
									
									$this->gaurantor   = $this->gaurantor->findBy(array('loan'=>$request->id))->row(0,'gaurantor_model');
									
									$this->loan->gaurantor = $this->gaurantor->id;

									$this->loan->collateral = $this->collateral->id;
									
									$this->customer    = $this->customer->findOne($this->loan->customer->id);
									
							}else{
							
									redirect(base_url().'loans/loanrequests/?message=Loan request not found. Please try again. If error persist contact the administrator&message_type=warning');
							
							}
							
					}else{
					
							redirect(base_url().'loans/loanrequests/?message=Error minimum requirements for action not met. Please try again&message_type=warning');
					
					}
					
					$this->page->title       = "Mombo Loan System | Edit Loan Request";
					
					$this->page->name  		 = 'mombo-edit-request';
					
					$this->msg['page']		 = $this->page;
					
					$this->msg['message']    = $message;
					
					$this->msg['errors']     = $errors;
					
				    $this->msg['collateral'] = $this->collateral;
					
					$this->msg['gaurantor']  = $this->gaurantor;
					
					$this->msg['request']    = $this->loan;
					
					$this->msg['products']   = $this->product->findAll();
					
					$this->msg['customer']   = $this->customer;
					
					$this->msg['criteria']   = '';
					
					$this->sendResponse($this->msg,array(
					
							$this->header => $this->msg,
							
							'mombo/templates/editloanrequest' => $this->msg,
							
							$this->footer => $this->msg,
					  )
					);
					
			 
			 }
			 
			 public function confirmrequest(){
				
					$loan = (int) $this->input->get_post('loan_id');
					
					$loan = $this->loan->findOne($loan);
					
					
					if($loan){
					
							 if($this->input->post('waiver_charge')){
							 
							      $waiver = (int) $this->input->get_post('transaction_fee_waiver');
								  
								  redirect(base_url().'loans/acceptloan/?confirmed=true&loan_id='.$loan->id.'&transaction_fee_waiver='.$waiver);
							 
							 }else{
							 
							       $this->page->title  = "Mombo Loan System | Accept Loan Waiver";
								   
								   $this->page->name   = 'mombo-waiver-loan';
								   
								   $this->msg['page']  = $this->page;
								   
								   $this->msg['loan']  = $loan;
								   
								   $this->msg['criteria'] = '';
								   
								   $this->sendResponse($this->msg,array(
								   
											$this->header => $this->msg,
											
											'mombo/templates/confirmrequest' => $this->msg,
											
											$this->footer => $this->msg,
								   ));
								   
							 }
							 
					
					}else{
					   
					     redirect(base_url().'loans/loanrequests/?message=Error. Minumum action requirement not met&message_type=warning');
					}
			 
			 }
			 
			 public function acceptloan(){
			 
					$loan_id = (int) $this->input->get_post('loan_id');

					$transaction_fee_waiver = 0;
					
					if($loan_id){
					
							$loan = $this->loan->findOne($loan_id);
					
							if(null != $loan){


								    if($loan->request_status == 2 ) redirect(base_url().'loans/loanrequests/?message=Loan request already accepted&message_type=info');
                                    
                                    if(!$this->input->get('confirmed')) redirect(base_url().'loans/confirmrequest?loan_id='.$loan->id);

                                    $transaction_fee_waiver = (int)$this->input->get_post('transaction_fee_waiver');

								    $customer_account = $this->customer_account->findBy(array(
											
													'customer' => $loan->customer->id,
													
											 )
									)->row(0,'customeraccount_model');

									
									if(null == $customer_account){
											
											$customer_account = array(
											
												'customer' => $loan->customer->id,
												
												'balance'  => 0
											);
											
											$added = $this->customer_account->create($customer_account);
											
											if(!$added) redirect(base_url().'loans/loanrequests/?message=Error creating customer ledger account. Please try again&message_type=warning');
											
											$customer_account = $this->customer_account->findBy(array(
											
													'customer' => $loan->customer->id,
													
											 )
											)->row(0,'customeraccount_model');
											
									       
									}

									
									$cash_account = $this->account->findOne($this->sys_option->findBy(array(
											
											'name'=>'loan_service_account'
											
									))->row(0,'systemoption_model')->value);
									
									$collection_account = $this->account->findOne($this->sys_option->findBy(array(
											
											'name'=>'loan_receipt_account'
											
									))->row(0,'systemoption_model')->value);

									
									if(null != $cash_account && null != $collection_account){

										        $time_stamp = time();
									
												if($cash_account->account_balance < $loan->loan_principle_amount ) redirect(base_url().'loans/loanrequests/?message=cash account balance is less than loan amount&message_type=warning');
												
												$cash_account->account_balance -= $loan->loan_principle_amount;
												
												$customer_account->balance     += $loan->loan_principle_amount;
												
												$transaction_code				= 'TRNS-'.date('Y-m',$time_stamp).strtoupper(random_string('alnum',4));
										
												$debit_transaction = array(
													
															'object' => $this->sys_object->findBy(array('name'=>'loan'))->row(0,'systemobject_model')->id,
														
															'transaction_code' => $transaction_code,
															
															'account' => $customer_account->id,
															
															'transactiontype' => 1,
															
															'description' => 'Loan amount received for '.$loan->loan_product->loan_product_name.' request' ,
															
															'date' => date('Y-m-d',$time_stamp),
															
															'amounttransacted' => $loan->loan_principle_amount,
															
															'user' => $this->session->userdata('user_id'),
												
												);
											
												$credit_transaction = array(
												
															'object' => $this->sys_object->findBy(array('name'=>'loan'))->row(0,'systemobject_model')->id,
														
															'transaction_code' => $transaction_code,
															
															'account' => $cash_account->id,
															
															'transactiontype' => 0,
															
															'description' => 'Customer Loan issue for '.$loan->loan_product->loan_product_name.' request',
															
															'date' => date('Y-m-d',$time_stamp),
															
															'amounttransacted' => $loan->loan_principle_amount,
															
															'user' => $this->session->userdata('user_id'),
												
												);

												
												if($customer_account->update() && $cash_account->update()){
												
														if($this->transaction->create($debit_transaction) && $this->transaction->create($credit_transaction)){
                                                               
												             $transaction_fee   = $loan->getTransactionFee()-$transaction_fee_waiver;
															 
															 $collection_account->account_balance += $transaction_fee;

												             if($transaction_fee > 0 ){

														               $transaction_fee_debit_transaction  = array(

															               		'object' => $this->sys_object->findBy(array('name'=>'loan'))->row(0,'systemobject_model')->id,
																	
																				'transaction_code' => $transaction_code,
																				
																				'account' => $customer_account->id,
																				
																				'transactiontype' => 1,
																				
																				'description' => 'Transction Fee for '.$loan->loan_product->loan_product_name.' issueance' ,
																				
																				'date' => date('Y-m-d',$time_stamp),
																				
																				'amounttransacted' => $transaction_fee,
																				
																				'user' => $this->session->userdata('user_id'),

														               );
																	   
																	   $transaction_fee_collection_debit_transaction  = array(

															               		'object' => $this->sys_object->findBy(array('name'=>'loan'))->row(0,'systemobject_model')->id,
																	
																				'transaction_code' => $transaction_code,
																				
																				'account' => $collection_account->id,
																				
																				'transactiontype' => 1,
																				
																				'description' => 'Transction Fee for '.$loan->loan_product->loan_product_name.' issueance' ,
																				
																				'date' => date('Y-m-d',$time_stamp),
																				
																				'amounttransacted' => $transaction_fee,
																				
																				'user' => $this->session->userdata('user_id'),

														               );
																	   
																	   
																	   $transaction_fee_credit_transaction  = array(

															               		'object' => $this->sys_object->findBy(array('name'=>'loan'))->row(0,'systemobject_model')->id,
																	
																				'transaction_code' => $transaction_code,
																				
																				'account' => $customer_account->id,
																				
																				'transactiontype' => 0,
																				
																				'description' => 'Transction Fee for '.$loan->loan_product->loan_product_name.' issueance' ,
																				
																				'date' => date('Y-m-d',$time_stamp),
																				
																				'amounttransacted' => $transaction_fee,
																				
																				'user' => $this->session->userdata('user_id'),

														               );

														                //Create charge records

														               $tfee_charge = array(

		                                                                      'name' => 'transction_fee',

		                                                                      'loan' => $loan->id,

		                                                                      'date' => date('Y-m-d',$time_stamp),

		                                                                      'amount' => $transaction_fee,

		                                                                      'balance' => 0,

		                                                                      'transaction_code' => $transaction_code,

		                                                                      'paid' => 1,
														               );

														       }

												               if($customer_account->update() && (($transaction_fee > 0) ? $this->loan_charge->create($tfee_charge) : true)){

																       if((($transaction_fee > 0) ? (($this->transaction->create($transaction_fee_debit_transaction) && $this->transaction->create($transaction_fee_credit_transaction) && $this->transaction->create($transaction_fee_collection_debit_transaction)) ? true : false ) : true)){

																	        
                                                                            if(strtolower($loan->loan_product->interest_type) == 'simple'){

                                                                            	  $loan->loan_amount_payable = round(($loan->loan_principle_amount + ($loan->loan_principle_amount * ($loan->loan_product->interest_rate / 100) * $loan->loan_duration)),0);

                                                                            }elseif(strtolower($loan->loan_product->interest_type) == 'compound'){
																			
																			     $pv  = $loan->loan_principle_amount;
																				 
																				 $i   = ($loan->loan_product->interest_rate+100) / 100;
																				 
																				 $n   = $loan->loan_duration;

                                                                                 $loan->loan_amount_payable = round($pv * pow($i,$n),0);
                                                                            }

                                                                            $loan->loan_balance_amount   = round(($loan->loan_amount_payable),0);

                                                                            $loan->total_interest_amount = $loan->loan_amount_payable - $loan->loan_principle_amount;

                                                                            $loan->installment_amount    = round(($loan->loan_amount_payable / $loan->loan_duration),0);

                                                                            $loan->installment_interest  = round(($loan->total_interest_amount / $loan->loan_duration),0);

                                                                            $loan->loan_issue_date       = date('Y-m-d',$time_stamp);


                                                                            $days  = 0;
																			


                                                                            switch (strtolower($loan->loan_product->loan_repayment_frequency)) {

                                                                            	case 'monthly':$days = 31;break;
																				
																				case 'annually':$days= 365;break;
																				
																				case 'weekly':$days=7;break;
																				
																				case 'per-two-months': $days = 63;break;
																				
																				case 'per-three-months':$days=93;break;
																				
																				case 'quartely':$days=124;break;
																				
																				case 'per-five-months':$days = 155;break;
																				
																				case 'twice-annually':$days=186;break;
																				
																				case 'per-seven-months':$days = 217;break;
																				
																				case 'per-eight-months':$days = 248;break;
																				
																				case 'per-nine-months':$days = 279;break;
																				
																				case 'per-ten-months':$days = 310;break;
																				
																				case 'per-elleven-months':$days = 341;break;
                                                                            	
                                                                            	default:break;
                                                                            }

                                                                            $loan->loan_due_date          = date('Y-m-d',(($loan->loan_duration * $days * 24 * 60 * 60)+$time_stamp));

																	        $total_interest_amount = 0;

																	        for($i=1;$i <= $loan->loan_duration; $i++){

																	        	  $expected_time_stamp = (($i*$days*24*60*60)+$time_stamp);

                                                                                  $expected_payment = array(

                                                                                  		'loan'   => $loan->id,

                                                                                  		'amount' => $loan->installment_amount,

                                                                                  		'balance' => $loan->installment_amount - $loan->installment_interest,

                                                                                  		'interest_amount' => $loan->installment_interest,

                                                                                  		'interest_amount_balance' => $loan->installment_interest,

                                                                                  		'date_expected' => date('Y-m-d',$expected_time_stamp),

                                                                                  		'paid'=> 0,

                                                                                  		'transaction_code' => $transaction_code,
                                                                                  );

																				  $customer_account->balance += $loan->installment_interest;
																				  $this->expected_payment->create($expected_payment);
																	        }
																			
																			round($customer_account->balance,0);

																	        $loan->request_status   = 2;

																	        $loan->transaction_code = $transaction_code;
																			
																			 $interest_debit_transaction  = array(

																						'object' => $this->sys_object->findBy(array('name'=>'loan'))->row(0,'systemobject_model')->id,
																			
																						'transaction_code' => $transaction_code,
																						
																						'account' => $customer_account->id,
																						
																						'transactiontype' => 1,
																						
																						'description' => 'Interest for '.$loan->loan_product->loan_product_name.' issueance' ,
																						
																						'date' => date('Y-m-d',time()),
																						
																						'amounttransacted' => $loan->total_interest_amount,
																						
																						'user' => $this->session->userdata('user_id'),

																			   );

																	        //send sms to customer and email to admin
																			 
																			 
																			 $updated_c  = $customer_account->update();
																			 
																			 $updated_cl = $collection_account->update();
																			 
																			 $updated_l  = $loan->update();
																			 
																			 $added_t    = $this->transaction->create($interest_debit_transaction);
																		   
																		    if($updated_c && $updated_cl && $updated_l && $added_t ) redirect(base_url().'loans/loansissued?criteria=all&message=Loan issued successfully&message_type=success');

															           }
															    }
																	   
														}
														
														 
												}
												
												foreach($this->transaction->findBy(array('transaction_code'=>$transaction_code))->result('transaction_model') as $transaction){
													 	 
													    $transaction->delete();
														 
												}


												foreach($this->expected_payment->findBy(array('transaction_code'=>$transaction_code))->result('expectedpayment_model') as $payment){
														
				                                     	$payment->delete();

												}


												foreach($this->loan_charge->findBy()->result('charge_model') as $charge){

                                                        $charge->delete();
												}
												
												
												$customer_account->balance -= $loan->loan_principle_amount+$transaction_fee+$service_fee;
												
												$customer_account->update();
												
												$cash_account->account_balance += $loan->loan_principle_amount;
												
												$cash_account->update();

												$loan->transaction_code = null;
												
												$loan->request_status   =  1;
												
												$loan->update();
												
												redirect(base_url().'loans/loanrequests/?message=Transaction error. Please try again&message_type=danger');
												
										}else{
									
												redirect(base_url().'loans/loanrequests/?message=loan servicing account unavailable or not set&message_type=warning');
									
									}
							
							}else{
							
									redirect(base_url().'loans/loanrequests/?message=loan request not found or does not exists&message_type=warning');
							
							}
					
					}else{
					
							redirect(base_url().'loans/loanrequests/?message=Error minimum action requirement not met.Please try again&message_type=warning');
					
					}
			 
			 }
			 
			 public function rejectloan(){

			 		$loan_id = (int) $this->input->get_post('loan_id');

			 	    if($loan_id){

			 	    			$loan = $this->loan->findOne($loan_id);

			 	    			if(null != $loan){

			 	    					$loan->request_status = 3;

			 	    					if($loan->update()){

			 	    						    //send SMS to user

			 	    						  	redirect(base_url().'loans/loanrequests/?message=Successfully rejected loan requests&message_type=success');

			 	    					}else{

			 	    						    redirect(base_url().'loans/loanrequests/?message=Error updating loan product. Please try again&message_type=danger');
                                                

			 	    					}

			 	    			}else{


			 	    				    redirect(base_url().'loans/loanrequests/?message=loan request not found or does not exists&message_type=warning');

			 	    			}

			 	    }else{

			 	    			redirect(base_url().'loans/loanrequests/?message=Error minimum action requirement not met.Please try again&message_type=warning');


			 	    }
			 
			 }

			 public function loanpaymentsandcharges(){

			 		$loan_id = (int) $this->input->get_post('loan_id');

			 		if($loan_id){

			 			     $loan = $this->loan->findOne($loan_id);

			 			     if(null != $loan){

	                                    $charges  =  $this->loan_charge->findBy(array(

	                                    		'loan' => $loan->id,

	                                    ),array(
												
												(int) $this->input->get_post('per_page'),
												
												20,
										
										
										));

	                                    $expected_payments  =  $this->expected_payment->findBy(array(
	                                          
	                                            'loan' => $loan->id
												
										  ),array(
												
												(int) $this->input->get_post('per_page'),
												
												20,
										
										
										));

	                                    $this->page->title         = "Mombo Loan System | Expected Payments & Charges";

	                                    $this->page->name          = 'mombo-loan-payments-and-charges';

	                                    $this->msg['page']         = $this->page;
										
										$this->msg['message']      = $this->input->get_post('message');
										
										$this->msg['message_type'] = $this->input->get_post('message_type');
   
	                                    $this->msg['loan']         = $loan;

	                                    $this->msg['charges']      = $charges;

	                                    $this->msg['payments']     = $expected_payments;
										
										$this->msg['current_tab']  = ($this->input->get_post('current_tab')) ?: 'loan_payments';

	                                    $this->sendResponse($this->msg,array(

	                                    		$this->header => $this->msg,

	                                    		'mombo/templates/paymentsandcharges' => $this->msg,

	                                    		$this->footer => $this->msg,

	                                    ));

			 			     }else{

			 	    				   redirect(base_url().'loans/loansissued/?message=loan request not found or does not exists&message_type=warning');

			 			     }

			 		}else{


			 	          redirect(base_url().'loans/loansissued/?message=Error minimum requirements for action not met&message_type=warning');


			 		}

			 }
			 
			 
			
			
			public function issueloan(){
			
				   $message = null;
				   
				   $errors  = null;
				   
				   if($this->input->get_post('issue_loan')){
				   
				           $amount    = $this->input->get_post('loan_amount');
						   
						   $duration  = $this->input->get_post('loan_duration');
						   
						   $product   = (int) $this->input->get_post('loan_product');
						   
						   $customer  = (int) $this->input->get_post('customer');
						   
						   if($customer && $product){
						   
						            $customer = $this->customer->findOne($customer);
									
									$product  = $this->product->findOne($product);
									
									if($customer && $product){
									
									           if($amount && $duration){
											   
														if(is_numeric($amount)&& is_numeric($duration)){
														
														          $maximum_amount    = $product->maximum_amount_loaned;
																  
																  $minimum_amount    = $product->minimum_amount_loaned;
																  
																  $maximum_duration  = $product->maximum_duration;
																  
																  $minimum_duration  = $product->minimum_duration;
																  
																  if($amount <= $maximum_amount && $amount >= $minimum_amount){
																  
																			if($duration <= $maximum_duration && $duration >= $minimum_duration){
																			
																			        $loan = array();
																					
																					$loan['transaction_code']				= 'TRNS-'.date('Y-m',time()).strtoupper(random_string('alnum',4));
													
																					$loan['customer']                       = $customer->id;
																					
																					$loan['loan_principle_amount']          = $amount;
																					
																					$loan['loan_product']                   = $product->id;
																					
																					$loan['loan_issue_date']                = null;
																					
																					$loan['loan_due_date']                  = null;
																					
																					$loan['loan_duration']                  = $duration;
																					
																					$loan['loan_balance_amount']            = 0;
																					
																					$loan['transaction_fee']                = 0;
																					
																					$loan['next_payment_date']              = null;
																					
																					$loan['request_status']                 = 1;
																					
																					$loan['loan_status']                    = 0;
																					
																					$loan['pmt']                            = 0;
																					
																					$added = $this->loan->create($loan);
																					
																					if($added){

																						  //send sms and email
																					
																					      redirect(base_url().'loans/loansissued/?message=Loan issued successfully to '.$customer->name.'!&message_type=success');
																					
																					}
													
																			
																			}else{
																			
																					$message = "Your loan duration does not fall in the accepted range for this product. Between ".$maximum_duration." and ".$minimum_duration;
																			
																			}
																  
																  }else{
                                                                     
																	   $message = "Your loan amount does not fall in the accepted range for this product. Between Ksh ".$maximum_amount." and Ksh ".$minimum_amount;
																  
																  }
														
														}else{
														
														     $message = "Please make sure the loan amount and duration are valid numerical values";
														
														}
											   
											   }else{
											   
											       $message = "Please make sure you have input the amount and duration";
											   
											   }
									
									}else{
									
									     $message = "Customer or Product selected does not exist";
										  
									}
						   
						   }else{
						      
							     $message = "Please make sure you a have selected the customer and product";
						   }
						   
				   
				   }
				   
				   $this->page->title 		= "Mombo Loan System | Issue Loan";
				   
				   $this->page->name  		= 'mombo-issue-loan';
				   
				   $this->msg['page'] 		= $this->page;
				   
				   $this->msg['message']    = $message;
				   
				   $this->msg['message_type'] = 'warning';
				   
				   $this->msg['errors']     = $errors;
				   
				   $this->msg['products']   = $this->product->findAll();
				   
				   $this->sendResponse($this->msg,array(
				   
				          $this->header => $this->msg,
						  
						  'mombo/templates/issueloan' => $this->msg,
						  
						  $this->footer => $this->msg,
				   ));
			   
			   
			
			}
			 
	/******End Loan Requests******/
	
	/******Loan Payments******/

	        public function pay(){

			      $payment_amount    = $this->input->get_post('payment_amount');
				  
				  $total_pay_amount  = $payment_amount;
				  
				  $loan = $this->loan;
				  
	        	  if($this->input->get_post('make_payment')){

	        	  				$loan_id = (int) $this->input->get_post('loan_id');

	        	  				if($loan_id){

			        	  				$loan    = $this->loan->findOne($loan_id);
										
										if($loan->loan_status == 1)  redirect(base_url().'loans/makepayment/?message=Loan item has been settled&message_type=success'); 

			        	  				if(null != $loan){

			        	  					        if($this->input->get_post('payment_channel') != 'cheque'){
													
														$collection_account = $this->account->findOne($this->sys_option->findBy(array(
												
																'name'=>'loan_receipt_account'
																
														))->row(0,'systemoption_model')->value);
														
													}else{
													   
													    
														$collection_account = $this->account->findOne($this->sys_option->findBy(array(
												
																'name'=>'cheque_receipt_account'
																
														))->row(0,'systemoption_model')->value);
													
													}
													
													//var_dump($collection_account);

													$customer_account   = $this->customer_account->findBy(array(
                                                            
                                                             'customer' => $loan->customer->id,
															 
												    ))->row(0,'customeraccount_model');
													
													//var_dump($customer_account);exit;

                                                    $charges        = $this->loan_charge->findBy(array(
                                                    	
                                                    	   'loan' => $loan->id,

                                                    	   'paid' => 0,

                                                    ));

                                                    $payments       = $this->expected_payment->findBy(array(

                                                    	'loan' => $loan->id,

                                                    	'paid' => 0,

                                                    ));



                                                    if($charges->num_rows() > 0){

                                                            foreach($charges->result('charge_model') as $charge){
															        
																	$amount_paid = 0;

                                                            		if($payment_amount > 0){

                                                            			  if($charge->balance >= $payment_amount){

			        	  					                                    $amount_paid      = $payment_amount;

                                                            			  	    $payment_amount   = 0;

	                                                            			    $charge->balance -= $amount_paid;

	                                                            	      }else{

	                                                            	      	    $amount_paid      = $charge->balance;

                                                                                $payment_amount  -= $charge->balance;

                                                                                $charge->balance  = 0;

	                                                            	      }

	                                                            	      $charge_pay   = array(

	                                                            	      	    'charge' => $charge->id,

	                                                            	      	    'date' => date('Y-m-d',time()),

	                                                            	      	    'amount' => $amount_paid,

	                                                            	      	    'channel' => $this->input->get_post('payment_channel'),

	                                                            	      	    'transaction_code' => $charge->transaction_code,

                                                            			  );

                                                            			  $debit_trans  = array(

                                                            			  	    'object' => $this->sys_object->findBy(array('name'=>'charge'))->row(0,'systemobject_model')->id,

                                                            			  		'transaction_code' => $charge->transaction_code,

                                                            			  		'account' => $collection_account->id,

                                                            			  		'transactiontype' => 1,

                                                            			  		'description' => "Payment for ".$charge->name." charge. ".$this->input->get_post('payment_description'),
																				
                                                            			  		'date' => date('Y-m-d',time()),

                                                            			  		'amounttransacted' => $amount_paid,

                                                            			  		'user' => $this->session->userdata('userid'),
                                                            			  );

                                                            			  $credit_trans = array(


                                                            			  	    'object' => $this->sys_object->findBy(array('name'=>'charge'))->row(0,'systemobject_model')->id,

                                                            			  		'transaction_code' => $charge->transaction_code,

                                                            			  		'account' => $customer_account->id,

                                                            			  		'transactiontype' => 0,

                                                            			  		'description' => "Payment for ".$charge->name." charge. ".$this->input->get_post('payment_description'),

                                                            			  		'date' => date('Y-m-d',time()),

                                                            			  		'amounttransacted' => $amount_paid,

                                                            			  		'user' => $this->session->userdata('userid'),
                                                            			  );

                                                                          $collection_account->account_balance += $amount_paid;
																		  
																		  $customer_account->balance -= $amount_paid;  
																		  
	                                                            	      if($charge->balance == 0) $charge->paid = 1;

	                                                            	      if($this->transaction->create($debit_trans) && $this->transaction->create($credit_trans)){

		                                                            	      	  if($this->charge_payment->create($charge_pay)){

			                                                            	      	  	 if($charge->update()){

			                                                            	      	  	 }else{

			                                                            	      	  	 	    redirect(base_url().'loans/makepayment?message=Error recording transaction&message_type=warning');

			                                                            	      	  	 }

		                                                            	      	  }else{

		                                                            	      	  	   redirect(base_url().'loans/makepayment?message=Error recording payment. Please try again&message_type=warning');
		                                                            	      	  }

	                                                            	      }else{

	                                                            	      	    redirect(base_url().'loans/makepayment?message=Error recording transaction.Please try again&message_type=warning');

	                                                            	      }

	                                                              }

                                                            }

                                                    }

                                                    if($payments->num_rows() > 0){

                                                    		foreach($payments->result('expectedpayment_model') as $payment){

                                                    			  $amount_paid = 0;

                                                                  $int_amount_paid = 0;

                                                    			  if($payment_amount > 0){

                                                                        
                                                                          if($payment->interest_amount_balance > 0 && $payment_amount > 0){

                                                                        	  if($payment->interest_amount_balance >= $payment_amount){

                                                                        	  		   $int_amount_paid  = $payment_amount;

                                                                        	  		   $payment->interest_amount_balance -= $int_amount_paid;

                                                                        	  		   $payment_amount  = 0;

                                                                        	  }else{
                                                                                       
                                                                                       $int_amount_paid = $payment->interest_amount_balance;

                                                                                       $payment_amount  -= $payment->interest_amount_balance;

                                                                                       $payment->interest_amount_balance = 0;

                                                                        	  }
																			  
																			  $loan->loan_balance_amount -= $int_amount_paid;
																			  
																			  
																		      $collection_account->account_balance += $int_amount_paid;
																		  
																		      $customer_account->balance -= $int_amount_paid;  
																			  
																			  $points = floor($int_amount_paid / 500);
																		
																			  $loan->customer->loyaltypoints = $points;
																				
																			  $loan->customer->update();


																					  
		                                        			  					if($payment->balance >= $payment_amount){
		                                                                             
		                                                                              $amount_paid       = $payment_amount;

		                                                                              $payment->balance -= $payment_amount;

		                                                                              $payment_amount    = 0;

		                                        			  					}else{

		                                        			  						 $amount_paid        = $payment->balance;

		                                        			  						 $payment_amount    -= $payment->balance;

		                                        			  						 $payment->balance   = 0;

		                                        			  					}
																				
																				 $loan->loan_balance_amount -= $amount_paid;
																				
																				 $collection_account->account_balance += $amount_paid;
																				  
																				 $customer_account->balance -= $amount_paid;  
																		


                                                                        	  $interest_paid = array(

	                                                                               'payment' => $payment->id,

	                                                                               'transaction_code' => $payment->transaction_code,

	                                                                               'payment_amount' => $int_amount_paid,

	                                                                               'payment_date' => date('Y-m-d',time()),

	                                                                               'payment_channel' => $this->input->get_post('payment_channel'),

	                                                                               'desc' => "Payment for customer loan interest. ".$this->input->get_post('payment_description'),

                                                                        	  );

                                                                        	  $debit_trans   = array(

	                                                                        	    'object' => $this->sys_object->findBy(array('name'=>'payment'))->row(0,'systemobject_model')->id,

	                                                            			  		'transaction_code' => $payment->transaction_code,

	                                                            			  		'account' => $collection_account->id,

	                                                            			  		'transactiontype' => 1,

	                                                            			  		'description' => "Payment for customer loan interest",

	                                                            			  		'date' => date('Y-m-d',time()),

	                                                            			  		'amounttransacted' => $int_amount_paid,

	                                                            			  		'user' => $this->session->userdata('userid'),

                                                                        	  );

                                                                        	  $credit_trans  = array(

	                                                                        	    'object' => $this->sys_object->findBy(array('name'=>'payment'))->row(0,'systemobject_model')->id,

	                                                            			  		'transaction_code' => $payment->transaction_code,

	                                                            			  		'account' => $customer_account->id,

	                                                            			  		'transactiontype' => 0,

	                                                            			  		'description' => "Payment for customer loan interest. ".$this->input->get_post('payment_description'),


	                                                            			  		'date' => date('Y-m-d',time()),

	                                                            			  		'amounttransacted' => $int_amount_paid,

	                                                            			  		'user' => $this->session->userdata('userid'),


                                                                        	  );

                                                                              if($this->transaction->create($debit_trans) && $this->transaction->create($credit_trans)){

	                                                                        		if($this->payment->create($interest_paid)){

		                                                                        		}else{

		                                                                        		        redirect(base_url().'loans/makepayment?message=Error recording payment. Please try again&message_type=warning');

		                                                                        			  

		                                                                        		}

		                                                                        }else{

			                                                            		       redirect(base_url().'loans/makepayment?message=Error recording transactions. Please try again&message_type=warning');

		                                                                        }

                                                                        }

                                                                        $payment_made = array(
                                                                               
                                                                               'payment' => $payment->id,

                                                                               'transaction_code' => $payment->transaction_code,

                                                                               'payment_amount' => $amount_paid,

                                                                               'payment_date' => date('Y-m-d',time()),

                                                                               'payment_channel' => $this->input->get_post('payment_channel'),

                                                                               'desc' => "Payment for customer loan installment. ".$this->input->get_post('payment_description'),


                                                                        );

                                                                        $debit_trans  = array(

                                                                        	    'object' => $this->sys_object->findBy(array('name'=>'payment'))->row(0,'systemobject_model')->id,

                                                            			  		'transaction_code' => $payment->transaction_code,

                                                            			  		'account' => $collection_account->id,

                                                            			  		'transactiontype' => 1,

                                                            			  		'description' => "Payment for customer loan installment. ".$this->input->get_post('payment_description'),


                                                            			  		'date' => date('Y-m-d',time()),

                                                            			  		'amounttransacted' => $amount_paid,

                                                            			  		'user' => $this->session->userdata('userid'),

                                                                        );

                                                                        $credit_trans = array(

                                                                        	    'object' => $this->sys_object->findBy(array('name'=>'payment'))->row(0,'systemobject_model')->id,

                                                            			  		'transaction_code' => $payment->transaction_code,

                                                            			  		'account' => $customer_account->id,

                                                            			  		'transactiontype' => 0,

                                                            			  		'description' => "Payment for customer loan installment. ".$this->input->get_post('payment_description'),

                                                            			  		'date' => date('Y-m-d',time()),

                                                            			  		'amounttransacted' => $amount_paid,

                                                            			  		'user' => $this->session->userdata('userid'),

                                                                        );

                                                                        
                                                                        if($this->transaction->create($debit_trans) && $this->transaction->create($credit_trans)){

                                                                        		if($this->payment->create($payment_made)){

                                                                        			  if($payment->balance == 0 && $payment->interest_amount_balance == 0) $payment->paid = 1;
                                                                                         
                                                                        			  if($payment->update()){
																					  
																					       continue;

                                                                        			  }else{

                                                                        			  	   redirect(base_url().'loans/makepayment?message=Error recording payment. Please try again&message_type=warning');

                                                                        			  }

                                                                        		}else{
                                                                        		        redirect(base_url().'loans/makepayment?message=Error recording payment. Please try again&message_type=warning');

                                                                        			  

                                                                        		}

                                                                        }else{

	                                                            		       redirect(base_url().'loans/makepayment?message=Error recording transactions. Please try again&message_type=warning');

                                                                        }
                                                    			  }

                                                            }

                                                    }else{
													
															if($charges->num_rows() <= 0){

																 /*if($loan->loan_balance_amount > 0 && $payment_amount > 0){
                                                                         
                                                                          $loan->loan_balance_amount -= $payment_amount;

																 }
															
															     if($loan->loan_balance_amount <= 0) {

															     	$loan->loan_balance_amount=0;$loan->loan_status = 1;

															     }*/

															      $loan->loan_status = 1;
																 
																 if($loan->update()) redirect(base_url().'loans/makepayment/?message=Loan item has been settled&message_type=success');
																 
																 redirect(base_url().'loans/makepayment/?message=Error closing loan item. Please try again&message=warning');
															
															}
													
													}
											     
																					  
													$customer_account->update();
													
													$collection_account->update();
													
													$charges = $this->loan_charge->findBy(array('loan'=>$loan->id,'paid'=>0));
   
                   
													if($loan->loan_balance_amount <= 0 && $charges->num_rows() <= 0){
													
													     $loan->loan_balance_amount = 0;

														 $loan->loan_status = 1;

													} 
													  
													$loan->update();

			        	  				}else{

			        	  					redirect(base_url().'loans/makepayment?message=Loan item not found&message_type=warning');

			        	  				}
			        	  	    }else{

			        	  	    	  redirect(base_url().'loans/makepayment?message=Error minimum action requirement not met. Please select a loan to make payment for&message_type=warning');


			        	  	    }


	        	  }else{

			 	          redirect(base_url().'loans/loansissued/?message=Error minimum requirements for action not met&message_type=warning');
                  
                  }
				  
				  
				  
				  
				  if($loan->loan_status == 1)redirect(base_url().'loans/makepayment/?message=Loan item has been settled&message_type=success');

				  //send sms and email

				  redirect(base_url().'loans/makepayment/?message=Payments made successfully!&message_type=success');


	        }

	        public function makepayment(){

	        	 $message 		            = $this->input->get_post('message');

	        	 $message_type 		        = $this->input->get_post('message_type');
 
	        	 $loans   			        = $this->loan->findBy(array('loan_status'=>0),array(0,20));

	        	 $this->page->title         = "Mombo Loan System | Make Payment";

	        	 $this->page->name      	= 'mombo-make-payment';

	        	 $this->msg['page'] 	 	= $this->page;

	        	 $this->msg['criteria']  	= '';

	        	 $this->msg['message']      = $message;

	        	 $this->msg['message_type'] = $message_type;

	        	 $this->msg['loans']     	= $loans;

	        	 $this->sendResponse($this->msg,array(

	        	 		$this->header => $this->msg,

	        	 		'mombo/templates/makepayment' => $this->msg,

	        	 		$this->footer => $this->msg,

	        	 ));  
	        }
			
			public function makeapayment(){
			
					$type     = strtolower($this->input->get_post('type'));
					
					$loan_id  = (int) $this->input->get_post('loan_id');
					
					$id       = 0;
					
                    $current_tab = 'loan_payments';
					
					$model    = null;
					
					$loan     = null;
					
					switch($type){
							
							case 'payment': $id = (int) $this->input->get_post('payment_id'); $current_tab = 'loan_payments'; break;
							
							case 'charge' : $id = (int) $this->input->get_post('charge_id');  $current_tab = 'loan_charges'; break;
							
							default:break;
					
					}
					
					if($id && $loan_id){
					
								if($type == 'payment'){
								
								     $model = 'expected_payment';
								
								}elseif($type == 'charge'){
								
								     $model = 'loan_charge';
								
								}else{
									   redirect(base_url().'loans/loanpaymentsandcharges/?message=Error minimum action requirements not met&message_type=warning&current_tab='.$current_tab.'&loan_id='.$loan_id);
								
								}
								
								$item = $this->$model->findOne($id);
								
								$loan = $this->loan->findOne($loan_id);
								
								if(null != $item && null != $loan){
								       
									       if($this->input->post('make_payment')){
										          
												    if($this->input->get_post('payment_channel') != 'cheque'){
													
														$collection_account = $this->account->findOne($this->sys_option->findBy(array(
												
																'name'=>'loan_receipt_account'
																
														))->row(0,'systemoption_model')->value);
														
													}else{
													   
													    
														$collection_account = $this->account->findOne($this->sys_option->findBy(array(
												
																'name'=>'cheque_receipt_account'
																
														))->row(0,'systemoption_model')->value);
													
													}
													
													 $customer_account = $this->customer_account->findBy(array(
											
															'customer'=>$loan->customer->id,
															
													   ))->row(0,'customeraccount_model');
										   
										            $payment = $item;
													
													$amount_paid = 0;
										   
										            $payment_amount   = $this->input->get_post('payment_amount');
													
													$payment_channel  = $this->input->get_post('payment_channel');
													
													if(!is_numeric($payment_amount))redirect(base_url().'loans/makeapayment/?message=Please provide an numeric payment amount&message_type=warning&loan_id='.$loan_id.'&type='.$type.'&'.$type.'_id='.$payment->id);
													
													if(empty($payment_channel))redirect(base_url().'loans/makeapayment/?message=Please provide a payment channel&message_type=warning&loan_id='.$loan_id.'&type='.$type.'&'.$type.'_id='.$payment->id);
													
													if($payment->balance >= $payment_amount){
															
															$payment->balance -= $payment_amount;
															
															$amount_paid       = $payment_amount;
															
															$payment_amount    = 0;
													
													
													}else{
															
															$amount_paid       = $payment->balance;
													
													        $payment_amount   -= $payment->balance;
															
															$payment->balance  = 0;
													}
													
													
													$collection_account->account_balance += $amount_paid;
													
													$customer_account->balance -= $amount_paid;
										   
													if($type == 'payment'){
													
													         $interest_amount = $payment->interest_amount_balance;
															 
															 $int_amount_paid = 0;
															
															 if($interest_amount > 0 && $payment_amount > 0){
															 
																		if($payment->interest_amount_balance >= $payment_amount){
																		
																				$payment->interest_amount_balance -= $payment_amount;
																				
																				$int_amount_paid = $payment_amount;
																		
																		}else{
																		
																		        $payment_amount -= $payment->interest_amount_balance;
																				
																				$int_amount_paid     = $payment->interest_amount_balance;
																				
																				$payment->interest_amount_balance = 0;
																		
																		}
																		
																		
																		$interest_payment = array(
																		
																				 'transaction_code' => $payment->transaction_code,
																 
																				 'payment'=> $payment->id,
																				 
																				 'payment_amount' => $int_amount_paid,
																				 
																				 'payment_date' => date('Y-m-d',time()),
																				 
																				 'payment_channel' => $payment_channel,
																				 
																				 'desc' => "Payment for customer loan interest. ".$this->input->get_post('payment_description'),

																		
																		);
																		
																		$interest_debit_transaction = array(
																		
																				'object' => $this->sys_object->findBy(array('name'=>'payment'))->row(0,'systemobject_model')->id,

                                                            			  		'transaction_code' => $payment->transaction_code,

                                                            			  		'account' => $collection_account->id,

                                                            			  		'transactiontype' => 1,

                                                            			  		'description' => "Payment for customer loan interest. ".$this->input->get_post('payment_description'),


                                                            			  		'date' => date('Y-m-d',time()),

                                                            			  		'amounttransacted' => $int_amount_paid,

                                                            			  		'user' => $this->session->userdata('userid'),
																		
																		
																		);
																		
																		$interest_credit_transaction = array(
																		        'object' => $this->sys_object->findBy(array('name'=>'payment'))->row(0,'systemobject_model')->id,

                                                            			  		'transaction_code' => $payment->transaction_code,

                                                            			  		'account' => $customer_account->id,

                                                            			  		'transactiontype' => 0,

                                                            			  		'description' => "Payment for loan interest. ".$this->input->get_post('payment_description'),


                                                            			  		'date' => date('Y-m-d',time()),

                                                            			  		'amounttransacted' => $int_amount_paid,

                                                            			  		'user' => $this->session->userdata('userid'),
																		        
																		);
																		
																		
																		$payment_made = $this->payment->create($interest_payment);
																		
																		$int_debited      = $this->transaction->create($interest_debit_transaction);
																		
																		$int_credited     = $this->transaction->create($interest_credit_transaction);
																		
																		if(!$payment_made && !$int_debited && !$int_credited){
																		  
																		    redirect(base_url().'loans/makeapayment/?message=Error recording payment. Please try again&message_type=warning&loan_id='.$loan_id.'&'.$type.'&'.$type.'_id='.$payment->id);
																		
																		}
																		
																		$loan->loan_balance_amount -= $int_amount_paid;
																		
																		$collection_account->account_balance += $int_amount_paid;
																		
																		$customer_account->balance -= $int_amount_paid;
																		
																		$points = floor($int_amount_paid / 500);
																		
																		$loan->customer->loyaltypoints = $points;
																		
																		$loan->customer->update();
																		
																		
																		
															 
															 }
															 
															 
														  $loan_payment = array(
																
																 'transaction_code' => $payment->transaction_code,
																 
																 'payment'=> $payment->id,
																 
																 'payment_amount' => $amount_paid,
																 
																 'payment_date' => date('Y-m-d',time()),
																 
																 'payment_channel' => $payment_channel,
																 
																 'desc' => "Payment for customer loan installment. ".$this->input->get_post('payment_description'),

														  
														  );
														  
														  $loan->loan_balance_amount -= $amount_paid;
															 
														  if(!$this->payment->create($loan_payment)){
																redirect(base_url().'loans/makeapayment/?message=Error recording payment. Please try again&message_type=warning&loan_id='.$loan_id.'&'.$type.'&'.$type.'_id='.$payment->id);
														  
														  }
															 
														  if($payment->balance == 0 && $payment->interest_amount_balance == 0) $payment->paid = 1;
													
													}elseif($type == 'charge'){
													
														  if($payment->balance == 0) $payment->paid = 1;
														  
														  if(!$this->charge_payment->create(array(
																	
																	'charge' => $payment->id,
																	
																	'date' => date('Y-m-d',time()),
																	
																	'amount' => $amount_paid,
																	
																	'channel' => $payment_channel,
																	
																	'transaction_code' => $payment->transaction_code,
														  
														   ))){
														   
														        redirect(base_url().'loans/makeapayment/?message=Error recording payment. Please try again&message_type=warning&loan_id='.$loan_id.'&'.$type.'&'.$type.'_id='.$payment->id);
																
														   }
														   
														  
													
													}
													
													$object = 'payment';
													
													$description_object = " installment";
													
													if($type == 'charge'){
													
													    $object = 'charge';
														
														$description_object = $payment->name;
														
												    }
													
													$payment_debit_transaction   = array(
													
															'object' => $this->sys_object->findBy(array('name'=>$object))->row(0,'systemobject_model')->id,

															'transaction_code' => $payment->transaction_code,

															'account' => $collection_account->id,

															'transactiontype' => 1,

															'description' => "Payment for loan ".$description_object.". ".$this->input->get_post('payment_description'),


															'date' => date('Y-m-d',time()),

															'amounttransacted' => $amount_paid,

															'user' => $this->session->userdata('userid'),
													);
													
													$payment_credit_transaction  = array(
															
															'object' => $this->sys_object->findBy(array('name'=>$object))->row(0,'systemobject_model')->id,

															'transaction_code' => $payment->transaction_code,

															'account' => $customer_account->id,

															'transactiontype' => 0,

															'description' => "Payment for loan ".$description_object.". ".$this->input->get_post('payment_description'),


															'date' => date('Y-m-d',time()),

															'amounttransacted' => $amount_paid,

															'user' => $this->session->userdata('userid'),
													
													);
													
													$debited    = $this->transaction->create($payment_debit_transaction);
													
													$credited   = $this->transaction->create($payment_credit_transaction);
													
													if(!$debited && !$credited)redirect(base_url().'loans/makeapayment/?message=Error recording transactions. Please try again&message_type=warning&loan_id='.$loan_id.'&'.$type.'&'.$type.'_id='.$payment->id);
													
												    if($payment->update()){
													
													          
																		
															  $collection_account->update();
																		
															  $customer_account->update();
													
															  $charges = $this->loan_charge->findBy(array('loan'=>$loan->id,'paid'=>0));

															   
															  if($loan->loan_balance_amount <= 0 && $charges->num_rows() <= 0){

																    $loan->loan_balance_amount  = 0;
																	
																	$loan->loan_status = 1;

															  } 

															  $loan->update();
															  
															  if($loan->loan_status == 1)redirect(base_url().'loans/loanpaymentsandcharges/?message=Loan item has been settled&message_type=success');
															 
															   //send sms and email
															  redirect(base_url().'loans/loanpaymentsandcharges/?message=Payment made successfully &message_type=success&current_tab='.$current_tab.'&loan_id='.$loan_id);
												
												    }else{
													
													    redirect(base_url().'loans/makeapayment/?message=Error recording payment. Please try again&message_type=warning&loan_id='.$loan_id.'&'.$type.'&'.$type.'_id='.$payment->id);
													
													}
										   
										   }else{
										   
												$this->$model = $item;
										   
										   }
										  
								}else{
								        
										redirect(base_url().'loans/loanpaymentsandcharges/?message=Error minimum action requirements not met&message_type=warning&current_tab='.$current_tab.'&loan_id='.$loan_id);
								
								}
					
					}else{
					
					     if($type== 'charge') $current_tab = 'loan_charges';
						 
						 if(!$loan_id) $loan_id = rand(5,20);
						 
						 redirect(base_url().'loans/loanpaymentsandcharges/?message=Error minimum action requirements not met&message_type=warning&current_tab='.$current_tab.'&loan_id='.$loan_id);
					
					}
					
					
					$this->page->title         = "Mombo Loan System | Make Payment";
					
					$this->page->name          = 'mombo-make-a-payment';
					
					$this->msg['page']         = $this->page;
					
					$this->msg['criteria']     = '';
					
					$this->msg['message']      = $this->input->get_post('message');
					
					$this->msg['message_type'] = $this->input->get_post('message_type');
					
					$this->msg['item']         = $this->$model;
					
					$this->msg['type']         = $type;
					
					$this->msg['loan']         = $loan;
 					
					$this->sendResponse($this->msg,array(
					   
					      $this->header => $this->msg,
						  
						  'mombo/templates/makeapayment' => $this->msg,
						  
						  $this->footer => $this->msg,
					
					));
			}
			
			public function waivercharge(){
			
					$charge_id     = (int) $this->input->get_post('charge_id');
					
					$loan_id       = (int) $this->input->get_post('loan_id');
					
					$message       = $this->input->get_post('message');
					
					$message_type  = $this->input->get_post('message_type');
					
					if(!$charge_id && !$loan_id) redirect(base_url().'loans/loansissued/?message=Error. action minimum requirements not met&message_type=warning');
					
					$charge = $this->loan_charge->findOne($charge_id);
					
					$loan   = $this->loan->findOne($loan_id);
					
					if(null == $charge || $loan == null)redirect(base_url().'loans/loansissued/?message=Error. charge item not found&message_type=warning');
					
					if($this->input->get_post('waiver_charge')){
					
							$waiver_amount    = $this->input->get_post('waiver_amount');
							
							$charge->waiver  += (float) $waiver_amount;
							
							$charge->balance -= (float) $waiver_amount;
							
							if($charge->balance == 0) $charge->paid = 1;
							
							if($charge->update()){
							
                                $charges = $this->loan_charge->findBy(array('loan'=>$loan->id, 'paid'=>0));
								
								if($loan->loan_balance_amount <= 0 && $charges->num_rows() <= 0 && $loan->loan_status == 0){
								
										$loan->loan_status = 1;
										
										$loan->update();
								
								}

								//send sms and email
								
								redirect(base_url().'loans/loanpaymentsandcharges/?message=Charge successfully waivered!&message_type=success&current_tab=loan_charges&loan_id='.$loan->id);
								
						    }
							
							$message      = "Error updating charge waiver. Please try again";
							
							$message_type =  'warning';
			
					}
					 
					$this->page->title          = "Mombo Loan System | Waiver Charge";
					
					$this->page->name           = 'mombo-waiver-charge';
					
					$this->msg['page']          = $this->page;
					
					$this->msg['criteria']      = '';
					
					$this->msg['message']       = $message;
					
					$this->msg['message_type']  = $message_type;
					
					$this->msg['loan']          = $loan;
					
					$this->msg['charge']        = $charge;
					
					$this->sendResponse($this->msg,array(
					
							$this->header => $this->msg,
							
							'mombo/templates/waivercharge'=>$this->msg,
							
							$this->footer => $this->msg,
					));
			}
			
			public function chargefeeonloan(){
			
			      $loan            = (int) $this->input->get_post('loan_id');
				  
				  $charge          = $this->input->get_post('charge');
				  
				  $charge_amount   = $this->input->get_post('charge_amount');
				  
				  $message         = null;
				  
				  $message_type    = null;
				  
				  
				  if($loan){
					  
						 $loan  = $this->loan->findOne($loan);
						 
						 if($loan != null){
						 
								 $this->loan = $loan;
								  
								 if($this->input->get_post('charge_loan')){
								 
											 if($charge && in_array($charge,array('upaidcheque_fee','latepayment_fee','transaction_fee','interest_fee','service_fee'))){
											  
														if($charge_amount && is_numeric($charge_amount)){
														
																		 $current_time_stamp = time();
																		 
																		 $customer_account   = $this->customer_account->findBy(array(
																		 
																				'customer' => $loan->customer->id
																				
																		 ))->row(0,'customeraccount_model');
														
																		 $charge = array(
																		 
																				'transaction_code' => $loan->transaction_code,
																				
																				'name' => $charge,
																				
																				'loan' => $loan->id,
																				
																				'date' => date('Y-m-d',$current_time_stamp),
																				
																				'amount' => $charge_amount,
																				
																				'balance' => $charge_amount,
																				
																				'paid'=>0,
																		 
																		 );
																		 
																		 $debit_transaction = array(
																
																				'object' => $this->sys_object->findBy(array('name'=>'charge'))->row(0,'systemobject_model')->id,

																				'transaction_code' => $loan->transaction_code,

																				'account' => $loan->customer->id,

																				'transactiontype' => 1,

																				'description' => $charge.$this->input->get_post('charge_description'),

																				'date' => date('Y-m-d',$current_time_stamp),

																				'amounttransacted' => $charge_amount,

																				'user' => $this->session->userdata('userid'),
																		);
																		
																		$customer_account->balance += $charge_amount;
																		
																		$loan->loan_status = 0;

																		$c_updated = $customer_account->update();

																		$l_updated = $loan->update();
																		
																		if($c_updated && $l_updated){

																			   $ch_created = $this->loan_charge->create($charge);

																			   $t_created = $this->transaction->create($debit_transaction);
																		
																			   if($ch_created && $t_created){
																			   
																						//send sms and email
																						redirect(base_url().'loans/loansissued/?message=Loan charged successfully!&message=success');
																			   
																			   }
																		
																		}
																		
																		$message      = "Error. Applying charge to loan. Please try again";
																		
																		$message_type  = 'warning';
														
														}else{
														
																$message = "Please provide a valid charge amount";
										   
																$message_type = "warning";
														
														}
										  
										  
										  }else{
										  
												 $message = "Charge item type not found. Please correct your inputs and try again";
									   
												 $message_type = "warning";
										  
										  }
										  
									}
							}else{
							
									redirect(base_url().'loans/loansissued/?message=Error. Loan item not found or doesnt exists&message=warning');
							}
				   
					  }else{
						   
						   redirect(base_url().'loans/loansissued/?message=Error. Action minimum requirement not met.Please try again&message=warning');
					  }
					  
				  
				  $this->page->title             =  "Mombo Loan System | Charge Loan";
				  
				  $this->page->name              = 'mombo-charge-loan';
				  
				  $this->msg['page']             = $this->page;
				  
				  $this->msg['message']			 = $message;
				  
				  $this->msg['message_type']     = $message_type;
				  
				  $this->msg['loan']             = $this->loan;
				  
				  $this->sendResponse($this->msg,array(
				  
							$this->header => $this->msg,
							
							'mombo/templates/chargeloan' => $this->msg,
							
							$this->footer => $this->msg,
				  ));
			}
			
			public function reschedulepayment(){
			
			      $payment_id = (int) $this->input->get_post('payment_id');
				  
				  $loan_id    = (int) $this->input->get_post('loan_id');
				  
				  if(!$payment_id && !$loan_id) redirect(base_url().'loans/loansissued/?message=Error. Action minimum requirement not met.Please try again&message_type=warning');
				  
				  $payment   = $this->expected_payment->findOne($payment_id);
				  
				  $loan      = $this->loan->findOne($loan_id);
				  
				  if(!$payment && !$loan) redirect(base_url().'loans/loansissued/?message=Error. Payment item or loan item not found&message_type=warning');
				  
				  if($this->input->get_post('reschedule_payment')){
				  
							$new_date                 = $this->input->get_post('new_date');
							
							$expected_payments        = $this->expected_payment->findWhere('date_expected >',$payment->date_expected);
							
							$customer_account         = $this->customer_account->findBy(array('customer'=>$loan->customer->id))->row(0,'customeraccount_model');
							
							$payment->date_expected   = $new_date;
							
							$current_time_stamp       = time();
							
							$new_time_stamp           = date_create($payment->date_expected)->getTimestamp();
							
							$loan_repayment_frequency = $loan->loan_product->loan_repayment_frequency;
							
							$days = 0;
							
							switch($loan_repayment_frequency){
							
									case 'monthly':$days = 31;break;
														
									case 'annually':$days= 365;break;
									
									case 'weekly':$days=7;break;
									
									case 'per-two-months': $days = 63;break;
									
									case 'per-three-months':$days=93;break;
									
									case 'quartely':$days=124;break;
									
									case 'per-five-months':$days = 155;break;
									
									case 'twice-annually':$days=186;break;
									
									case 'per-seven-months':$days = 217;break;
									
									case 'per-eight-months':$days = 248;break;
									
									case 'per-nine-months':$days = 279;break;
									
									case 'per-ten-months':$days = 310;break;
									
									case 'per-elleven-months':$days = 341;break;
									
									default:break;
							}
							
							
							foreach($expected_payments->result('expectedpayment_model') as $pay){
							
								      $new_time_stamp += ($days * 24 * 60 * 60);
									  
									  $pay->date_expected = date('Y-m-d',$new_time_stamp);
									  
									  $pay->update();
							
							}
							$reschedulement_fee   = $loan->getReschedulementFee();
							
							$customer_account->balance += $reschedulement_fee;
							
							$charge = array(
												   
									'transaction_code' => $loan->transaction_code,
									
									'name' => 'reschedulment_charge',
									
									'loan' => $loan->id,
									
									'date' => date('Y-m-d',$current_time_stamp),
									
									'amount' => $reschedulement_fee,
									
									'balance' => $reschedulement_fee,
									
									'paid'=>0,
							 
							);
							
							$debit_transaction =  array(
							
									'object' => $this->sys_object->findBy(array('name'=>'charge'))->row(0,'systemobject_model')->id,

									'transaction_code' => $loan->transaction_code,

									'account' => $customer_account->id,

									'transactiontype' => 1,

									'description' => "Payment reschedulement fee for payment expected on ".$payment->date_expected,

									'date' => date('Y-m-d',time()),

									'amounttransacted' => $reschedulement_fee,

									'user' => $this->session->userdata('userid'),
							
							
							);
							
							if(!$this->loan_charge->create($charge) && !$this->transaction->create($debit_transaction))redirect(base_url().'loans/loanpaymentsandcharges/?message=Error updating loan charges&message_type=warning&loan_id='.$loan->id);
							
							if($payment->update() && $customer_account->update()){

								 //send sms and email

								 redirect(base_url().'loans/loanpaymentsandcharges/?message=Loan payment rescheduled successfully!&message_type=success&loan_id='.$loan->id);
							
							}

							$_POST['message']      = "Error rescheduling loan. Please try again";
							
							$_POST['message_type'] = 'warning';
				  
				  
				  }
				  
				  $this->page->title         = "Mombo Loan System | Reschedule Payment";
				  
				  $this->page->name           = 'mombo-reschedule-payment';
				  
				  $this->msg['page']          = $this->page;
				  
				  $this->msg['criteria']      = '';
				  
				  $this->msg['message']       = $this->input->get_post('message');
				  
				  $this->msg['message_type']  = $this->input->get_post('message_type');
				  
				  $this->msg['payment']       = $payment;
				  
				  $this->msg['loan']          = $loan;
				  
				  $this->sendResponse($this->msg,array(
				  
				        $this->header => $this->msg,
						
						'mombo/templates/rescheduleloan' => $this->msg,
						
						$this->footer => $this->msg,
				  
				  ));
				  
				  
			}
			
			public function loanpayments(){
			
			     $payments = $this->payment->findAll();
				 
				 $expectedpayments = $this->expected_payment->findAll();

				 if($this->input->get_post('days_past')){

                       $days_past = (int) $this->input->get_post('days_past');


				 }
				 
				 $this->page->title               = "Mombo Loan System | Payments";
				 
				 $this->page->name                = 'mombo-loan-payments';
				 
				 $this->msg['page']               = $this->page;
				 
				 $this->msg['payments']           = $payments;
				 
				 $this->msg['expectedpayments']   = $expectedpayments;
				 
				 $this->sendResponse($this->msg,array(
					
					    $this->header => $this->msg,
						
						'mombo/templates/payments' => $this->msg,
						
						$this->footer => $this->msg,
				 
				 ));
			
			
			}
			
			public function loansdenied(){
			
				 $loans = $this->loan->findBy(array('request_status' => 3));
				 
				 $this->page->title      = "Mombo Loan System | Denied Loan Requests";
				 
				 $this->page->name       = 'mombo-loan-payments';
				 
				 $this->msg['page']      = $this->page;
				 
				 $this->msg['loans']     = $loans;
				 
				 $this->sendResponse($this->msg,array(
					
					    $this->header => $this->msg,
						
						'mombo/templates/deniedloans' => $this->msg,
						
						$this->footer => $this->msg,
				 
				 ));
			
			}
			
			public function collateralsandgaurantors(){
			
			     $collaterals = $this->collateral->findAll();
				 
				 $gaurantors  = $this->gaurantor->findAll();
				 
				 $this->page->title        = "Mombo Loan System | Collateral & Gaurantors";
				 
				 $this->page->name         = 'mombo-collaterals-gaurantors';
				 
				 $this->msg['page']        = $this->page;
				 
				 $this->msg['collaterals'] = $collaterals;
				 
				 $this->msg['gaurantors']  = $gaurantors;
				 
				 $this->sendResponse($this->msg,array(
						
						$this->header => $this->msg,
						
						'mombo/templates/collateralandgaurantors' => $this->msg,
						
						$this->footer => $this->msg,
				 ));
			}
			
			
			public function loansummary(){
			
			
			}
			
			
			public function dobulkaction(){
			
			}
	
	/******End  Loan Payments******/
	 
}